<!DOCTYPE html>
<html lang="en">
<head>
    <!-- EMERGENCY SELECTOR FIX: Simplified version to prevent crashes -->
    <script src="js/emergency-selector-fix.js"></script>
    
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta charset="utf-8"/>
    <meta content="Fooodis Blog Dashboard - Create and Manage Blog Content" name="keywords"/>
    <meta content="Admin dashboard for creating and managing blog content for the Fooodis website." name="description"/>
    <title>Fooodis Blog Dashboard (Fixed Version)</title>
    <!-- Storage Manager and Fixes - Must be loaded before all other scripts -->
    <script src="js/storage-manager.js"></script>
    <script src="js/storage-fix.js"></script>
    <script src="js/data-persistence-diagnostic.js"></script>
    <script src="js/schedule-persistence-fix.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <!-- Core scripts -->
    <script src="js/jquery.js"></script>
    <script src="js/nicepage.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/dashboard-fixes-new.js"></script>
    <script src="js/footer-bubbles.js"></script>
    
    <!-- Feature-specific scripts -->
    <script src="js/post-scheduler.js"></script>
    <script src="js/categories-dark.js"></script>
    <script src="js/ai-assistant-dark.js"></script>
    <script src="js/post-scheduler-dark.js"></script>
    <script src="js/schedule-popup-dark.js"></script>
    <script src="js/scheduled-posts-dark.js"></script>
    <script src="js/schedule-dark-fix.js"></script>
    <script src="js/date-time-picker-dark.js"></script>
    
    <!-- AI Configuration scripts -->
    <script src="js/ai-config-dark.js"></script>
    <script src="js/ai-config-integration.js"></script>
    <script src="js/ai-config-fix.js"></script>
    
    <!-- AI Automation scripts - load in correct order -->
    <script src="js/ai-automation-scheduler-fix.js"></script>
    <script src="js/ai-automation.js"></script>
    <script src="js/automation-media-folders.js"></script>
    <script src="js/generate-now.js"></script>
    <script src="js/automation-fix.js"></script>
    
    <!-- Email Subscribers Media Fix - Ensures media selector loads pictures correctly -->
    <script src="js/email-media-sync-fix.js"></script>
    
    <!-- Media management scripts -->
    <script src="js/folder-icons.js"></script>
    <script src="js/media-folders.js"></script>
    
    <!-- Theme scripts -->
    <script src="js/mode-toggle.js"></script>
    <!-- Core styles -->
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/dashboard-extensions.css">
    <link rel="stylesheet" href="css/dashboard-styles.css">
    
    <!-- Additional styles for the fixed version -->
    <style>
        .execution-status-cards-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .execution-status-card {
            margin: 10px 0;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .status-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .status-card-header i {
            margin-right: 10px;
            color: #0066cc;
        }
        
        .status-card-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background-color: #0066cc;
            transition: width 0.3s;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 9999;
            max-width: 300px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .notification.error {
            background-color: #F44336;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- Copy the entire body content from dashboard.html here -->
    <!-- This is a placeholder - you need to copy the actual content -->
    <div id="content-placeholder">
        Loading dashboard content...
    </div>
    
    <!-- Direct fix script - injected directly into the page -->
    <script>
        // Wait for DOM to be loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load the dashboard content
            fetch('dashboard.html')
                .then(response => response.text())
                .then(html => {
                    // Extract the body content
                    const bodyContent = html.match(/<body[^>]*>([\s\S]*)<\/body>/i)[1];
                    document.getElementById('content-placeholder').innerHTML = bodyContent;
                    
                    // Initialize the fixes after a short delay
                    setTimeout(initFixes, 1000);
                })
                .catch(error => {
                    console.error('Error loading dashboard content:', error);
                    document.getElementById('content-placeholder').innerHTML = 
                        '<div style="padding: 20px; color: red;">Error loading dashboard content. Please try refreshing the page.</div>';
                });
        });
        
        /**
         * Initialize all fixes
         */
        function initFixes() {
            console.log('Initializing fixes...');
            
            // Fix 1: Time display
            fixTimeDisplay();
            
            // Fix 2: Card persistence
            fixCardPersistence();
            
            // Fix 3: Post publishing
            fixPostPublishing();
            
            console.log('All fixes initialized');
            
            // Show a notification
            showNotification('Dashboard fixed version loaded successfully. All automation fixes have been applied.');
        }
        
        /**
         * Fix 1: Time display
         */
        function fixTimeDisplay() {
            console.log('Fixing time display...');
            
            // Override the calculateNextRun function
            window.calculateNextRun = function(path) {
                if (!path || !path.active || !path.schedule || !path.schedule.time) {
                    return null;
                }
                
                // Just use Today or Tomorrow with the exact time string
                const now = new Date();
                const [hours, minutes] = path.schedule.time.split(':').map(Number);
                
                const scheduleTime = new Date();
                scheduleTime.setHours(hours, minutes, 0, 0);
                
                // Use Tomorrow if the time has already passed today
                const dateStr = (scheduleTime > now) ? 'Today' : 'Tomorrow';
                
                // Return with the EXACT original time string
                return dateStr + ', ' + path.schedule.time;
            };
            
            // Fix time display on existing cards
            setTimeout(function() {
                const pathCards = document.querySelectorAll('.automation-path');
                pathCards.forEach(function(card, index) {
                    const nextRunElement = card.querySelector('.next-run');
                    if (nextRunElement && window.automationPaths && window.automationPaths[index]) {
                        const path = window.automationPaths[index];
                        if (path.schedule && path.schedule.time) {
                            const nextRun = window.calculateNextRun(path);
                            if (nextRun) {
                                nextRunElement.textContent = 'Next run: ' + nextRun;
                            }
                        }
                    }
                });
            }, 500);
        }
        
        /**
         * Fix 2: Card persistence
         */
        function fixCardPersistence() {
            console.log('Fixing card persistence...');
            
            // Initialize storage for in-progress paths
            if (!localStorage.getItem('fixedInProgress')) {
                localStorage.setItem('fixedInProgress', JSON.stringify([]));
            }
            
            // Override the createExecutionStatusCard function
            window.createExecutionStatusCard = function(path) {
                console.log('Creating execution status card for path:', path?.name);
                
                if (!path || !path.id) return;
                
                // Check if a card already exists
                const existingCard = document.querySelector('.execution-status-card[data-path-id="' + path.id + '"]');
                if (existingCard) {
                    console.log('Card already exists for path:', path.name);
                    return;
                }
                
                // Make sure the container exists
                let container = document.querySelector('.execution-status-cards-container');
                if (!container) {
                    console.log('Creating execution status cards container');
                    container = document.createElement('div');
                    container.className = 'execution-status-cards-container';
                    
                    // Find the automation section
                    const section = document.querySelector('#ai-automation-section');
                    if (section) {
                        // Try to insert after the header
                        const header = section.querySelector('.section-header');
                        if (header) {
                            section.insertBefore(container, header.nextSibling);
                        } else {
                            section.insertBefore(container, section.firstChild);
                        }
                    } else {
                        // Fallback to adding to the body
                        document.body.appendChild(container);
                    }
                }
                
                // Create the card
                const card = document.createElement('div');
                card.className = 'execution-status-card';
                card.dataset.pathId = path.id;
                
                card.innerHTML = `
                    <div class="status-card-header">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <h3>Generating Content</h3>
                    </div>
                    <div class="status-card-content">
                        <p>Generating post for "${path.name}"</p>
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                `;
                
                // Add the card to the container
                container.appendChild(card);
                
                // Animate the progress bar
                const progressFill = card.querySelector('.progress-fill');
                if (progressFill) {
                    let width = 0;
                    const interval = setInterval(() => {
                        width = (width + 1) % 100;
                        progressFill.style.width = width + '%';
                    }, 100);
                    card.dataset.intervalId = interval;
                }
                
                // Track the path in localStorage
                let inProgress = [];
                try {
                    const saved = localStorage.getItem('fixedInProgress');
                    if (saved) {
                        inProgress = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Error parsing in-progress paths:', e);
                }
                
                if (!inProgress.includes(path.id)) {
                    inProgress.push(path.id);
                    localStorage.setItem('fixedInProgress', JSON.stringify(inProgress));
                    console.log('Added path to in-progress list:', path.id);
                }
            };
            
            // Override the removeExecutionStatusCard function
            window.removeExecutionStatusCard = function(path) {
                console.log('Removing execution status card for path:', path?.name);
                
                if (!path || !path.id) return;
                
                // Find the card
                const card = document.querySelector('.execution-status-card[data-path-id="' + path.id + '"]');
                if (card) {
                    // Clear any intervals
                    if (card.dataset.intervalId) {
                        clearInterval(parseInt(card.dataset.intervalId));
                    }
                    
                    // Remove the card
                    card.remove();
                }
                
                // Remove from in-progress list
                let inProgress = [];
                try {
                    const saved = localStorage.getItem('fixedInProgress');
                    if (saved) {
                        inProgress = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Error parsing in-progress paths:', e);
                }
                
                const index = inProgress.indexOf(path.id);
                if (index !== -1) {
                    inProgress.splice(index, 1);
                    localStorage.setItem('fixedInProgress', JSON.stringify(inProgress));
                    console.log('Removed path from in-progress list:', path.id);
                }
            };
            
            // Restore cards on page load
            setTimeout(function() {
                console.log('Restoring execution status cards...');
                
                // Get in-progress paths
                let inProgress = [];
                try {
                    const saved = localStorage.getItem('fixedInProgress');
                    if (saved) {
                        inProgress = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Error parsing in-progress paths:', e);
                }
                
                if (inProgress.length === 0) {
                    console.log('No in-progress paths found');
                    return;
                }
                
                console.log('Found in-progress paths:', inProgress);
                
                // Get automation paths
                const paths = window.automationPaths || [];
                
                // Create cards for in-progress paths
                inProgress.forEach(function(pathId) {
                    const path = paths.find(p => p.id === pathId);
                    if (path) {
                        console.log('Restoring card for path:', path.name);
                        window.createExecutionStatusCard(path);
                    } else {
                        console.warn('Path not found for ID:', pathId);
                        
                        // Remove from in-progress list
                        const index = inProgress.indexOf(pathId);
                        if (index !== -1) {
                            inProgress.splice(index, 1);
                            localStorage.setItem('fixedInProgress', JSON.stringify(inProgress));
                        }
                    }
                });
            }, 1000);
        }
        
        /**
         * Fix 3: Post publishing
         */
        function fixPostPublishing() {
            console.log('Fixing post publishing...');
            
            // Override the publishAutomatedPost function
            window.publishAutomatedPost = function(post) {
                console.log('Publishing post:', post?.title);
                
                try {
                    // Validate post
                    if (!post) {
                        throw new Error('Post is null or undefined');
                    }
                    
                    if (!post.title) {
                        throw new Error('Post has no title');
                    }
                    
                    if (!post.content) {
                        throw new Error('Post has no content');
                    }
                    
                    // Ensure post has an ID
                    if (!post.id) {
                        post.id = Date.now().toString();
                    }
                    
                    // Get existing posts
                    let blogPosts = [];
                    try {
                        const saved = localStorage.getItem('fooodis-blog-posts');
                        if (saved) {
                            blogPosts = JSON.parse(saved);
                        }
                    } catch (e) {
                        console.error('Error parsing blog posts:', e);
                    }
                    
                    // Ensure it's an array
                    if (!Array.isArray(blogPosts)) {
                        blogPosts = [];
                    }
                    
                    // Prepare the post
                    post.date = new Date().toISOString();
                    post.language = post.language || 'english';
                    post.status = 'published';
                    post.category = post.category || 'Uncategorized';
                    
                    // Add to the beginning of the array
                    blogPosts.unshift(post);
                    
                    // Save to localStorage
                    try {
                        localStorage.setItem('fooodis-blog-posts', JSON.stringify(blogPosts));
                        console.log('Post saved successfully:', post.title);
                        
                        // Show success notification
                        showNotification('Post "' + post.title + '" published successfully!');
                    } catch (e) {
                        console.error('Error saving post:', e);
                        
                        // Try with fewer posts if localStorage is full
                        if (blogPosts.length > 10) {
                            const trimmed = blogPosts.slice(0, 10);
                            try {
                                localStorage.setItem('fooodis-blog-posts', JSON.stringify(trimmed));
                                console.log('Saved trimmed posts');
                                
                                // Show success notification
                                showNotification('Post "' + post.title + '" published successfully (with trimmed history)!');
                            } catch (trimError) {
                                console.error('Error saving trimmed posts:', trimError);
                                throw new Error('Could not save post to localStorage');
                            }
                        } else {
                            throw new Error('Could not save post to localStorage');
                        }
                    }
                    
                    // Return success
                    return {
                        success: true,
                        post: post,
                        url: 'blog.html?post=' + post.id
                    };
                } catch (error) {
                    console.error('Error publishing post:', error);
                    
                    // Show error notification
                    showNotification('Error publishing post: ' + error.message, 'error');
                    
                    // Return error
                    return {
                        success: false,
                        error: error.message
                    };
                }
            };
        }
        
        /**
         * Show a notification message
         */
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification' + (type === 'error' ? ' error' : '');
            notification.textContent = message;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>
