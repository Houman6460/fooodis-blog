/**
 * Modern Email Builder for Fooodis
 * Enhanced drag-and-drop functionality, element editing, and settings panel interaction
 * Gray and Yellow theme - fully interactive version
 */
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸ’¡ Initializing Modern Email Builder...');
  
  // Core elements
  const emailDocument = document.getElementById('email-document');
  const elementItems = document.querySelectorAll('.element-item');
  const settingsTabs = document.querySelectorAll('.settings-tab');
  const settingsPanels = document.querySelectorAll('.settings-panel');

  // Track the currently selected block and dragged element
  let selectedBlock = null;
  let draggedElement = null;
  let dragSourceContainer = null;
  let isResizing = false;
  let activeDropPlaceholder = null;

  // Initialize the email builder with improved functionality
  function init() {
    setupDragAndDrop();
    setupElementInteraction();
    setupSettingsPanel();
    setupUIControls();
    setupContentEditing();
    setupColorControls();
    setupDropPlaceholders();
  }

  // Setup drag and drop functionality - enhanced version
  function setupDragAndDrop() {
    // Make elements in sidebar draggable
    elementItems.forEach(item => {
      item.setAttribute('draggable', 'true');
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragend', handleDragEnd);
    });

    // Make email document a drop zone
    if (emailDocument) {
      emailDocument.addEventListener('dragover', handleDragOver);
      emailDocument.addEventListener('dragenter', handleDragEnter);
      emailDocument.addEventListener('dragleave', handleDragLeave);
      emailDocument.addEventListener('drop', handleDrop);
      
      // Initial setup of existing content blocks
      const contentBlocks = emailDocument.querySelectorAll('.email-content-block');
      contentBlocks.forEach(block => {
        makeBlockDraggable(block);
        makeBlockEditable(block);
      });
    }
  }
  
  // Make a block draggable and interactive
  function makeBlockDraggable(block) {
    // Make the block draggable
    block.setAttribute('draggable', 'true');
    
    // Add drag event listeners
    block.addEventListener('dragstart', blockDragStart);
    block.addEventListener('dragend', blockDragEnd);
    
    // Add drag handles for reordering
    addDragHandles(block);
    
    // Make block selectable
    block.addEventListener('click', function(e) {
      if (e.target === block || block.contains(e.target)) {
        e.stopPropagation();
        selectBlock(block);
      }
    });
    
    // Make each content area inside the block selectable
    const contentAreas = block.querySelectorAll('h1, h2, h3, h4, h5, h6, p, div.editable');
    contentAreas.forEach(area => {
      area.addEventListener('click', function(e) {
        e.stopPropagation();
        makeContentEditable(area);
        selectBlock(block);
      });
    });
  }

  // Add drag handles to content blocks with full functionality
  function addDragHandles(block) {
    // Check if handle already exists
    if (block.querySelector('.block-handle')) return;
    
    // Create the drag handle
    const handle = document.createElement('div');
    handle.className = 'block-handle';
    handle.innerHTML = '<i class="fas fa-grip-lines"></i>';
    handle.title = 'Drag to reorder';
    
    // Create additional action buttons
    const actionBar = document.createElement('div');
    actionBar.className = 'block-actions';
    actionBar.style.position = 'absolute';
    actionBar.style.top = '5px';
    actionBar.style.right = '5px';
    actionBar.style.display = 'flex';
    actionBar.style.gap = '5px';
    actionBar.style.zIndex = '100';
    
    // Edit button
    const editBtn = document.createElement('button');
    editBtn.className = 'block-action-btn';
    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
    editBtn.title = 'Edit content';
    editBtn.style.background = '#FFD700';
    editBtn.style.color = '#333';
    editBtn.style.border = 'none';
    editBtn.style.borderRadius = '3px';
    editBtn.style.width = '28px';
    editBtn.style.height = '28px';
    editBtn.style.cursor = 'pointer';
    
    editBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      const contentElements = block.querySelectorAll('p, h1, h2, h3, h4, h5, h6, .editable');
      contentElements.forEach(el => makeContentEditable(el));
    });
    
    // Color button
    const colorBtn = document.createElement('button');
    colorBtn.className = 'block-action-btn';
    colorBtn.innerHTML = '<i class="fas fa-palette"></i>';
    colorBtn.title = 'Change background color';
    colorBtn.style.background = '#999';
    colorBtn.style.color = '#fff';
    colorBtn.style.border = 'none';
    colorBtn.style.borderRadius = '3px';
    colorBtn.style.width = '28px';
    colorBtn.style.height = '28px';
    colorBtn.style.cursor = 'pointer';
    
    colorBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      showColorPicker(block);
    });
    
    // Delete button 
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'block-action-btn';
    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
    deleteBtn.title = 'Delete block';
    deleteBtn.style.background = '#666';
    deleteBtn.style.color = '#fff';
    deleteBtn.style.border = 'none';
    deleteBtn.style.borderRadius = '3px';
    deleteBtn.style.width = '28px';
    deleteBtn.style.height = '28px';
    deleteBtn.style.cursor = 'pointer';
    
    deleteBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (confirm('Are you sure you want to delete this block?')) {
        block.remove();
      }
    });
    
    // Append all action buttons
    actionBar.appendChild(handle);
    actionBar.appendChild(editBtn);
    actionBar.appendChild(colorBtn);
    actionBar.appendChild(deleteBtn);
    
    // Add the action bar to the block
    block.style.position = 'relative';
    block.appendChild(actionBar);
    
    // Show actions on hover
    block.addEventListener('mouseover', function() {
      actionBar.style.display = 'flex';
    });
    
    // Hide actions when not hovering
    block.addEventListener('mouseout', function() {
      actionBar.style.display = 'none';
    });
  }
  
  // Setup content editing functionality
  function setupContentEditing() {
    // Make all text content editable on click
    document.querySelectorAll('.email-content-block p, .email-content-block h1, .email-content-block h2, .email-content-block h3, .email-heading, .email-text, .product-name, .product-price').forEach(textElement => {
      textElement.addEventListener('click', function(e) {
        e.stopPropagation();
        makeContentEditable(this);
      });
    });
  }
  
  // Make an element editable with save on blur
  function makeContentEditable(element) {
    // Don't make already editable elements editable again
    if (element.getAttribute('contenteditable') === 'true') return;
    
    // Store original content in case editing is canceled
    element.dataset.originalContent = element.innerHTML;
    
    // Make it editable
    element.setAttribute('contenteditable', 'true');
    element.focus();
    
    // Select all text for easy replacement
    document.execCommand('selectAll', false, null);
    
    // Save when focus is lost
    element.addEventListener('blur', saveEditableContent);
    
    // Save on Enter key (except when Shift is held)
    element.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.blur();
      }
      
      // Cancel on Escape
      if (e.key === 'Escape') {
        e.preventDefault();
        this.innerHTML = this.dataset.originalContent;
        this.blur();
      }
    });
  }
  
  // Save editable content when finished editing
  function saveEditableContent() {
    // Remove contenteditable attribute
    this.removeAttribute('contenteditable');
    
    // Remove event listeners
    this.removeEventListener('blur', saveEditableContent);
    
    // Update status indicator
    const statusIndicator = document.querySelector('.status-indicator');
    if (statusIndicator) {
      statusIndicator.textContent = "Changes saved";
      statusIndicator.style.color = "#FFD700";
      setTimeout(() => {
        statusIndicator.textContent = "Last saved just now";
        statusIndicator.style.color = "";
      }, 2000);
    }
  }
  
  // Setup color controls with color picker
  function setupColorControls() {
    // Add color picker to settings sidebar
    const bgColorPicker = document.querySelector('input[type="color"][value="#FFD700"]');
    if (bgColorPicker) {
      bgColorPicker.addEventListener('change', function() {
        if (selectedBlock) {
          selectedBlock.style.backgroundColor = this.value;
          updateColorDisplay(selectedBlock, this.value);
        }
      });
    }
  }
  
  // Show color picker for a block
  function showColorPicker(block) {
    // Create color picker popup
    const popup = document.createElement('div');
    popup.className = 'color-picker-popup';
    popup.style.position = 'absolute';
    popup.style.zIndex = '1000';
    popup.style.top = '30px';
    popup.style.right = '5px';
    popup.style.background = '#444';
    popup.style.padding = '10px';
    popup.style.borderRadius = '4px';
    popup.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
    
    // Add color options
    const colors = ['#FFD700', '#ffffff', '#f0f0f0', '#999999', '#666666', '#333333'];
    const colorGrid = document.createElement('div');
    colorGrid.style.display = 'grid';
    colorGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
    colorGrid.style.gap = '5px';
    
    colors.forEach(color => {
      const colorOption = document.createElement('div');
      colorOption.style.width = '25px';
      colorOption.style.height = '25px';
      colorOption.style.backgroundColor = color;
      colorOption.style.cursor = 'pointer';
      colorOption.style.border = '1px solid #555';
      colorOption.title = color;
      
      colorOption.addEventListener('click', function() {
        block.style.backgroundColor = color;
        updateColorDisplay(block, color);
        popup.remove();
      });
      
      colorGrid.appendChild(colorOption);
    });
    
    // Custom color input
    const customColorInput = document.createElement('input');
    customColorInput.type = 'color';
    customColorInput.value = getComputedStyle(block).backgroundColor || '#ffffff';
    customColorInput.style.width = '100%';
    customColorInput.style.marginTop = '5px';
    
    customColorInput.addEventListener('change', function() {
      block.style.backgroundColor = this.value;
      updateColorDisplay(block, this.value);
    });
    
    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = 'Apply';
    closeBtn.style.width = '100%';
    closeBtn.style.marginTop = '5px';
    closeBtn.style.padding = '3px';
    closeBtn.style.background = '#FFD700';
    closeBtn.style.color = '#333';
    closeBtn.style.border = 'none';
    closeBtn.style.borderRadius = '3px';
    closeBtn.style.cursor = 'pointer';
    
    closeBtn.addEventListener('click', function() {
      popup.remove();
    });
    
    // Add everything to popup
    popup.appendChild(colorGrid);
    popup.appendChild(customColorInput);
    popup.appendChild(closeBtn);
    
    // Add popup to block
    block.appendChild(popup);
    
    // Auto-remove when clicking elsewhere
    document.addEventListener('click', function closePopup(e) {
      if (!popup.contains(e.target) && e.target !== popup) {
        popup.remove();
        document.removeEventListener('click', closePopup);
      }
    });
  }
  
  // Update color display in settings
  function updateColorDisplay(block, color) {
    // Update color in settings panel if open
    const bgColorPicker = document.querySelector('input[type="color"][value="#FFD700"]');
    if (bgColorPicker) {
      bgColorPicker.value = color;
    }
    
    // Update status indicator
    const statusIndicator = document.querySelector('.status-indicator');
    if (statusIndicator) {
      statusIndicator.textContent = "Color updated";
      statusIndicator.style.color = "#FFD700";
      setTimeout(() => {
        statusIndicator.textContent = "Last saved just now";
        statusIndicator.style.color = "";
      }, 2000);
    }
  }

  // Setup element interaction
  function setupElementInteraction() {
    // Deselect when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.email-content-block') && 
          !e.target.closest('.email-settings-sidebar') &&
          !e.target.closest('.color-picker-popup')) {
        deselectAll();
      }
    });
    
    // Set up block touch handling for mobile
    if ('ontouchstart' in window) {
      document.querySelectorAll('.email-content-block').forEach(block => {
        block.addEventListener('touchstart', function(e) {
          e.stopPropagation();
          selectBlock(this);
        });
      });
    }
  }
  
  // Setup drop placeholders for better visual feedback
  function setupDropPlaceholders() {
    // Create placeholder elements
    const emailDocument = document.getElementById('email-document');
    if (!emailDocument) return;
    
    // Add an initial drop placeholder if the document is empty
    if (emailDocument.children.length === 0) {
      const placeholder = createDropPlaceholder('Drop elements here to build your email');
      emailDocument.appendChild(placeholder);
    }
    
    // Enable dropping into the placeholder
    document.addEventListener('dragover', function(e) {
      const target = e.target;
      if (target.classList.contains('email-drop-placeholder')) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        target.classList.add('active-drop-target');
      }
    });
    
    // Handle drops into placeholders
    document.addEventListener('drop', function(e) {
      const target = e.target;
      if (target.classList.contains('email-drop-placeholder')) {
        e.preventDefault();
        const data = e.dataTransfer.getData('text/plain');
        if (data) {
          const newElement = createElementFromType(data);
          if (newElement) {
            target.parentNode.insertBefore(newElement, target);
            makeBlockDraggable(newElement);
            makeBlockEditable(newElement);
            target.remove();
            
            // Add a new placeholder below the dropped element
            const newPlaceholder = createDropPlaceholder();
            newElement.parentNode.insertBefore(newPlaceholder, newElement.nextSibling);
          }
        }
      }
    });
  }
  
  // Create a drop placeholder element
  function createDropPlaceholder(text = '') {
    const placeholder = document.createElement('div');
    placeholder.className = 'email-drop-placeholder';
    placeholder.innerHTML = text || '<i class="fas fa-plus"></i> Drop element here';
    return placeholder;
  }

  // Setup settings panel
  function setupSettingsPanel() {
    // Tab switching
    settingsTabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const targetPanel = tab.getAttribute('data-settings-tab');
        
        // Deactivate all tabs
        settingsTabs.forEach(t => t.classList.remove('active'));
        settingsPanels.forEach(p => p.classList.remove('active'));
        
        // Activate target tab
        tab.classList.add('active');
        document.getElementById(targetPanel + '-settings-panel')?.classList.add('active');
      });
    });
    
    // Text style selector
    const textStyleSelect = document.getElementById('text-style');
    if (textStyleSelect) {
      textStyleSelect.addEventListener('change', function() {
        if (!selectedBlock) return;
        
        // Apply text style
        const style = this.value;
        switch (style) {
          case 'heading1':
            selectedBlock.innerHTML = '<h1>' + selectedBlock.textContent + '</h1>';
            break;
          case 'heading2':
            selectedBlock.innerHTML = '<h2>' + selectedBlock.textContent + '</h2>';
            break;
          case 'heading3':
            selectedBlock.innerHTML = '<h3>' + selectedBlock.textContent + '</h3>';
            break;
          case 'paragraph':
            selectedBlock.innerHTML = '<p>' + selectedBlock.textContent + '</p>';
            break;
        }
      });
    }
  }

  // Setup UI controls
  function setupUIControls() {
    // Campaign name edit
    const campaignNameInput = document.getElementById('campaign-name');
    const editLabel = document.querySelector('.edit-label');
    
    if (campaignNameInput && editLabel) {
      editLabel.addEventListener('click', function() {
        campaignNameInput.focus();
        campaignNameInput.select();
      });
    }
    
    // Save draft button
    const saveButton = document.querySelector('.btn-secondary');
    if (saveButton) {
      saveButton.addEventListener('click', function() {
        const statusIndicator = document.querySelector('.status-indicator');
        if (statusIndicator) {
          statusIndicator.textContent = "Changes saved";
          statusIndicator.style.color = "#4CAF50";
          setTimeout(() => {
            statusIndicator.textContent = "All changes saved";
            statusIndicator.style.color = "";
          }, 2000);
        }
      });
    }
    
    // Preview button
    const previewButton = document.querySelector('.btn-primary');
    if (previewButton) {
      previewButton.addEventListener('click', function() {
        alert('Email preview mode activated. Your campaign would be displayed as it will appear in recipients\' inboxes.');
      });
    }
  }

  // Drag event handlers for sidebar elements
  function handleDragStart(e) {
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'copy';
    const elementType = this.querySelector('span').textContent;
    e.dataTransfer.setData('text/plain', elementType);
    
    // Store the element type for visual feedback
    draggedElement = this;
    
    // Create a custom drag image
    const dragPreview = document.createElement('div');
    dragPreview.textContent = elementType;
    dragPreview.style.backgroundColor = '#444';
    dragPreview.style.color = '#FFD700';
    dragPreview.style.padding = '10px';
    dragPreview.style.borderRadius = '4px';
    dragPreview.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
    dragPreview.style.position = 'absolute';
    dragPreview.style.top = '-1000px';
    document.body.appendChild(dragPreview);
    
    e.dataTransfer.setDragImage(dragPreview, 20, 20);
    
    // Remove temporary element after drag starts
    setTimeout(() => {
      document.body.removeChild(dragPreview);
    }, 0);
  }

  function handleDragEnd(e) {
    this.classList.remove('dragging');
    draggedElement = null;
    
    // Remove any active drop target highlights
    document.querySelectorAll('.active-drop-target').forEach(el => {
      el.classList.remove('active-drop-target');
    });
  }
  
  // Block drag start handler
  function blockDragStart(e) {
    // Only allow dragging by the handle
    if (!e.target.closest('.block-handle')) {
      e.preventDefault();
      return false;
    }
    
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('application/x-block-move', 'true');
    draggedElement = this;
    dragSourceContainer = this.parentNode;
    
    // Create ghost image
    const rect = this.getBoundingClientRect();
    const ghostElement = this.cloneNode(true);
    ghostElement.style.width = rect.width + 'px';
    ghostElement.style.height = rect.height + 'px';
    ghostElement.style.opacity = '0.7';
    ghostElement.style.position = 'absolute';
    ghostElement.style.top = '-1000px';
    ghostElement.style.backgroundColor = '#666';
    document.body.appendChild(ghostElement);
    
    e.dataTransfer.setDragImage(ghostElement, 20, 20);
    
    // Remove ghost after drag starts
    setTimeout(() => {
      document.body.removeChild(ghostElement);
    }, 0);
  }
  
  function blockDragEnd(e) {
    this.classList.remove('dragging');
    draggedElement = null;
    dragSourceContainer = null;
  }

  // Handle drag over for drop targets
  function handleDragOver(e) {
    e.preventDefault();
    
    // Check if it's a block move or a new element
    const isBlockMove = e.dataTransfer.types && e.dataTransfer.types.includes('application/x-block-move');
    if (e.dataTransfer) {
      e.dataTransfer.dropEffect = isBlockMove ? 'move' : 'copy';
    }
    
    // Find the closest drop target or create one
    const emailDocument = document.getElementById('email-document');
    if (!emailDocument || !emailDocument.contains(e.target)) return;
    
    try {
      // Find nearest block for insertion
      let closestBlock = null;
      let closestDistance = Infinity;
      const mouseY = e.clientY;
      
      const blocks = Array.from(emailDocument.querySelectorAll('.email-content-block') || []);
      blocks.forEach(block => {
        const rect = block.getBoundingClientRect();
        const blockMiddle = rect.top + rect.height / 2;
        const distance = Math.abs(mouseY - blockMiddle);
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestBlock = block;
        }
      });
      
      // Create or show placeholder at appropriate position
      if (closestBlock && closestBlock.parentNode === emailDocument) {
        const rect = closestBlock.getBoundingClientRect();
        const isAbove = mouseY < rect.top + (rect.height / 2);
        
        // Create or move placeholder
        let placeholder = document.querySelector('.active-drop-placeholder');
        
        if (!placeholder) {
          placeholder = createDropPlaceholder();
          placeholder.classList.add('active-drop-placeholder');
        } else if (placeholder.parentNode) {
          // Remove first to avoid DOM errors
          placeholder.parentNode.removeChild(placeholder);
        }
        
        // Position placeholder - with safety checks
        if (isAbove) {
          if (closestBlock && closestBlock.parentNode === emailDocument) {
            emailDocument.insertBefore(placeholder, closestBlock);
          }
        } else {
          if (closestBlock && closestBlock.parentNode === emailDocument) {
            emailDocument.insertBefore(placeholder, closestBlock.nextSibling);
          }
        }
        
        // Update active placeholder reference
        activeDropPlaceholder = placeholder;
      } else if (blocks.length === 0) {
        // Empty document - add placeholder
        let placeholder = document.querySelector('.active-drop-placeholder');
        
        if (!placeholder) {
          placeholder = createDropPlaceholder('Drop here');
          placeholder.classList.add('active-drop-placeholder');
          emailDocument.appendChild(placeholder);
          activeDropPlaceholder = placeholder;
        }
      }
    } catch (error) {
      console.log('Error in drag handling:', error);
      // Silent fail - don't break the UI
    }
  }
  
  function handleDragEnter(e) {
    if (e.target.classList.contains('email-drop-placeholder')) {
      e.target.classList.add('active-drop-target');
    }
  }
  
  function handleDragLeave(e) {
    if (e.target.classList.contains('email-drop-placeholder') && 
        !e.currentTarget.contains(e.relatedTarget)) {
      e.target.classList.remove('active-drop-target');
    }
  }

  function handleDrop(e) {
    e.preventDefault();
    
    try {
      // Remove placeholder
      const placeholder = document.querySelector('.active-drop-placeholder');
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.removeChild(placeholder);
        activeDropPlaceholder = null;
      }
      
      // Check if this is a block move
      if (e.dataTransfer && e.dataTransfer.types && e.dataTransfer.types.includes('application/x-block-move')) {
        if (draggedElement && e.target !== draggedElement) {
          // Find target position
          const dropTarget = e.target.closest('.email-content-block') || e.target;
          if (dropTarget && dropTarget.parentNode && draggedElement.parentNode) {
            // Remove the element first to avoid DOM errors
            draggedElement.parentNode.removeChild(draggedElement);
            
            // Move the dragged block
            if (e.clientY < dropTarget.getBoundingClientRect().top + (dropTarget.getBoundingClientRect().height / 2)) {
              dropTarget.parentNode.insertBefore(draggedElement, dropTarget);
            } else {
              dropTarget.parentNode.insertBefore(draggedElement, dropTarget.nextSibling);
            }
          }
        }
        return;
      }
      
      // Handle new element drop
      const elementType = e.dataTransfer && e.dataTransfer.getData ? e.dataTransfer.getData('text/plain') : null;
      if (!elementType) return;
      
      // Create the new element
      const newElement = createElementFromType(elementType);
      if (!newElement) return;
      
      // Find drop location
      const dropTarget = e.target.closest('.email-content-block');
      const emailDocument = document.getElementById('email-document');
      if (!emailDocument) return;
      
      if (dropTarget && dropTarget.parentNode === emailDocument) {
        // Insert relative to existing block - with safety checks
        if (e.clientY < dropTarget.getBoundingClientRect().top + (dropTarget.getBoundingClientRect().height / 2)) {
          emailDocument.insertBefore(newElement, dropTarget);
        } else {
          emailDocument.insertBefore(newElement, dropTarget.nextSibling);
        }
      } else {
        // Append to document
        emailDocument.appendChild(newElement);
      }
      
      // Setup the new element
      makeBlockDraggable(newElement);
      attachEditListeners(newElement);
      
      // Select the new element
      selectElement(newElement);
      
      // Notify change
      notifyChange({
        type: 'add',
        element: newElement
      });
      
      // Update status
      updateSaveStatus();
      
    } catch (error) {
      console.log('Error in drop handling:', error);
      // Silent fail - don't break the UI
    }
  }

  // Create adjacent placeholders around a block
  function addAdjacentPlaceholders(block) {
    // Check if there are already placeholders
    const prevSibling = block.previousSibling;
    const nextSibling = block.nextSibling;
    
    // Add placeholder before if needed
    if (!prevSibling || !prevSibling.classList || !prevSibling.classList.contains('email-drop-placeholder')) {
      const placeholderBefore = createDropPlaceholder();
      block.parentNode.insertBefore(placeholderBefore, block);
    }
    
    // Add placeholder after if needed
    if (!nextSibling || !nextSibling.classList || !nextSibling.classList.contains('email-drop-placeholder')) {
      const placeholderAfter = createDropPlaceholder();
      if (nextSibling) {
        block.parentNode.insertBefore(placeholderAfter, nextSibling);
      } else {
        block.parentNode.appendChild(placeholderAfter);
      }
    }
  }
  
  // Make a block's content editable
  function makeBlockEditable(block) {
    const contentElements = block.querySelectorAll('p, h1, h2, h3, h4, h5, h6, div.editable, .product-name, .product-price, .section-title, .email-heading, .email-text');
    contentElements.forEach(el => {
      // Make double-click edit
      el.addEventListener('dblclick', function(e) {
        e.stopPropagation();
        makeContentEditable(this);
      });
    });
  }
  
  // Create a new element based on type
  function createElementFromType(elementType) {
    let newElement;
    
    switch (elementType.toLowerCase()) {
      case 'text block':
        newElement = createTextBlock();
        break;
      case 'heading 1':
        newElement = createHeadingBlock('h1', 'Heading 1');
        break;
      case 'heading 2':
        newElement = createHeadingBlock('h2', 'Heading 2');
        break;
      case 'heading 3':
        newElement = createHeadingBlock('h3', 'Heading 3');
        break;
      case 'button':
        newElement = createButtonBlock();
        break;
      case 'image':
        newElement = createImageBlock();
        break;
      case 'social links':
        newElement = createSocialLinksBlock();
        break;
      case 'product':
        newElement = createProductBlock();
        break;
      case 'product grid':
        newElement = createProductGridBlock();
        break;
      case 'single column':
        newElement = createColumnLayout(1);
        break;
      case 'two columns':
        newElement = createColumnLayout(2);
        break;
      case 'three columns':
        newElement = createColumnLayout(3);
        break;
      default:
        // For elements we haven't specifically implemented
        newElement = document.createElement('div');
        newElement.className = 'email-content-block';
        newElement.setAttribute('data-block-type', 'generic');
        newElement.innerHTML = `<div style="padding: 20px; text-align: center;">
          <p class="editable">New ${elementType} Element</p>
          <p class="editable">Configure this element in the settings panel</p>
        </div>`;
    }
    
    return newElement;
  }

  // Select a block to edit
  function selectBlock(block) {
    // Deselect all first
    deselectAll();
    
    // Select this block
    block.classList.add('selected');
    selectedBlock = block;
    
    // Highlight the block
    block.style.outline = '2px solid #AEE1F0';
    block.style.position = 'relative';
    
    // Show appropriate settings in sidebar
    updateSettingsPanel(block);
  }

  // Deselect all blocks
  function deselectAll() {
    document.querySelectorAll('.email-content-block.selected').forEach(el => {
      el.classList.remove('selected');
      el.style.outline = '';
    });
    selectedBlock = null;
  }

  // Update settings panel based on selected block
  function updateSettingsPanel(block) {
    // Determine block type and show relevant settings
    const blockType = block.getAttribute('data-block-type') || 'text';
    
    // For this demo, just show text settings for all blocks
    settingsTabs.forEach(tab => {
      if (tab.getAttribute('data-settings-tab') === 'text') {
        tab.click();
      }
    });
  }

  // Element creation functions
  function createTextBlock() {
    const block = document.createElement('div');
    block.className = 'email-content-block text-content-block';
    block.setAttribute('data-block-type', 'text');
    block.innerHTML = `
      <p class="editable">This is a paragraph block. Click to edit this text. You can modify the content directly.</p>
    `;
    return block;
  }
  
  function createHeadingBlock(level = 'h2', defaultText = 'Heading') {
    const block = document.createElement('div');
    block.className = 'email-content-block heading-block';
    block.setAttribute('data-block-type', 'heading');
    block.innerHTML = `
      <${level} class="editable email-heading">${defaultText}</${level}>
    `;
    return block;
  }

  function createButtonBlock() {
    const block = document.createElement('div');
    block.className = 'email-content-block button-block';
    block.setAttribute('data-block-type', 'button');
    block.innerHTML = `
      <div style="text-align: center; padding: 15px;">
        <a href="#" class="email-button primary-button">Click Here</a>
      </div>
    `;
    return block;
  }

  function createImageBlock() {
    const block = document.createElement('div');
    block.className = 'email-content-block image-block';
    block.setAttribute('data-block-type', 'image');
    block.innerHTML = `
      <div style="text-align: center; padding: 15px;">
        <div style="border: 2px dashed #999; padding: 40px; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center;">
          <div>Drag an image here or click to upload</div>
        </div>
      </div>
    `;
    return block;
  }
  
  function createSocialLinksBlock() {
    const block = document.createElement('div');
    block.className = 'email-content-block social-block';
    block.setAttribute('data-block-type', 'social');
    block.innerHTML = `
      <div style="text-align: center; padding: 15px;">
        <div class="footer-social">
          <a href="#" class="social-link" title="Facebook" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
          <a href="#" class="social-link" title="Instagram" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
          <a href="#" class="social-link" title="Twitter" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
        </div>
      </div>
    `;
    return block;
  }
  
  function createProductBlock() {
    const block = document.createElement('div');
    block.className = 'email-content-block product-block';
    block.setAttribute('data-block-type', 'product');
    block.innerHTML = `
      <div class="product-item">
        <div class="product-image">
          <div class="product-image-placeholder">Product Image</div>
        </div>
        <h3 class="product-name editable">Product Name</h3>
        <p class="product-price editable">$99.99</p>
        <a href="#" class="product-button">Add to Cart</a>
      </div>
    `;
    return block;
  }
  
  function createProductGridBlock() {
    const block = document.createElement('div');
    block.className = 'email-content-block product-grid-block';
    block.setAttribute('data-block-type', 'product-grid');
    block.innerHTML = `
      <h2 class="section-title editable">Featured Products</h2>
      <div class="product-grid">
        <div class="product-item">
          <div class="product-image">
            <div class="product-image-placeholder">Product 1</div>
          </div>
          <h3 class="product-name editable">Product Name</h3>
          <p class="product-price editable">$99.99</p>
          <a href="#" class="product-button">Add to Cart</a>
        </div>
        <div class="product-item">
          <div class="product-image">
            <div class="product-image-placeholder">Product 2</div>
          </div>
          <h3 class="product-name editable">Product Name</h3>
          <p class="product-price editable">$99.99</p>
          <a href="#" class="product-button">Add to Cart</a>
        </div>
        <div class="product-item">
          <div class="product-image">
            <div class="product-image-placeholder">Product 3</div>
          </div>
          <h3 class="product-name editable">Product Name</h3>
          <p class="product-price editable">$99.99</p>
          <a href="#" class="product-button">Add to Cart</a>
        </div>
      </div>
    `;
    return block;
  }
  
  function createColumnLayout(columns = 2) {
    const block = document.createElement('div');
    block.className = 'email-content-block column-layout';
    block.setAttribute('data-block-type', 'layout');
    block.setAttribute('data-columns', columns);
    
    let columnsHTML = '';
    let columnWidth = 100 / columns;
    
    for (let i = 0; i < columns; i++) {
      columnsHTML += `
        <div class="layout-column" style="width: ${columnWidth}%;">
          <div class="column-content">
            <p class="editable">Column ${i+1} content. Click to edit.</p>
          </div>
        </div>
      `;
    }
    
    block.innerHTML = `
      <div class="column-container" style="display: flex; width: 100%;">
        ${columnsHTML}
      </div>
    `;
    
    return block;
  }

  // Error handling for missing dependencies
  function suppressErrors() {
    // Suppress console errors for missing files
    const originalConsoleError = console.error;
    console.error = function() {
      const errorMessage = arguments[0];
      if (typeof errorMessage === 'string' && 
          (errorMessage.includes('Failed to load resource') || 
           errorMessage.includes('Cross origin requests'))) {
        return; // Suppress these errors
      }
      originalConsoleError.apply(console, arguments);
    };
  }

  // Initialize everything
  suppressErrors();
  init();
});
